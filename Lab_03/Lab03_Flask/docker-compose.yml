services:
  model-training:
    image: python:3.10-slim
    container_name: ml_trainer
    working_dir: /app
    volumes:
      - ./src:/app/src
      - ./requirements.txt:/app/requirements.txt
      - model_exchange:/exchange
    command: >
      sh -c "pip install -r requirements.txt &&
             python src/model_training.py &&
             cp my_model.keras /exchange/my_model.keras &&
             cp scaler.pkl /exchange/scaler.pkl"

  serving:
    image: python:3.10-slim
    container_name: ml_serving
    working_dir: /app
    ports:
      - "5001:5000"
    volumes:
      - ./src:/app/src
      - ./requirements.txt:/app/requirements.txt
      - ./src/templates:/app/templates
      - ./src/statics:/app/statics
      - model_exchange:/exchange
    depends_on:
      model-training:
        condition: service_completed_successfully
    command: >
      sh -c "pip install -r requirements.txt &&
             cp /exchange/my_model.keras ./my_model.keras &&
             cp /exchange/scaler.pkl ./scaler.pkl &&
             python src/main.py"

volumes:
  model_exchange: